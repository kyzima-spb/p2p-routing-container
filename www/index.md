> **Не работает! Ведется работа по полному обновлению контейнера**

Router
======

- [Введение](#введение)
- [Какой VPS выбрать?](#какой-vps-выбрать)
  - [Минимальные системные требования при выборе VPS](#минимальные-системные-требования-при-выборе-vps)
  - [Чем пользовался я и что могу посоветовать](#чем-пользовался-я-и-что-могу-посоветовать)
  - [Чем пользуются мои друзья](#чем-пользуются-мои-друзья)
- [Установка](#установка)
  - [Автоматическая установка](#автоматическая-установка)
  - [После установки](#после-установки)
- [Удаление](#удаление)
- [Полезные команды](#полезные-команды)
- [Особенности контейнера](#особенности-контейнера)
  - [Нестандартный способ маршрутизации](#нестандартный-способ-маршрутизации)
  - [Намеренное удаление IPv6-адресов](#намеренное-удаление-ipv6-адресов)
  - [Работа со сторонними DNS-зонами](#работа-со-сторонними-dns-зонами)

## Введение

**Router** - контейнерное решение для организации маршрутизации трафика в режиме "точка-точка".
Позволяет изолировать сетевой поток, направлять его через заданные интерфейсы или туннели,
а также использовать контейнер как промежуточный маршрутизатор/фильтр без необходимости задействовать хостовую систему.

**Какие преимущества?**
Контейнер направляет трафик на свои серверы только к сайтам и сервисам из списка,
такая точечная маршрутизация не снижает скорость открытия других сайтов.

## Какой VPS выбрать?

При выборе VPS стоит ориентироваться на физическое расположение сервера и пинг.
Ниже приведены минимальные необходимые системные требования, все что отсутствует в списке - большой роли не играет.

### Минимальные системные требования при выборе VPS

* Личный сервер или VPS с виртуализацией XEN или KVM (OpenVZ не подойдёт)
* Выделенный IPv4-адрес
* Минимум 1Gb оперативной памяти
* Минимум 5Gb дискового пространства
* Дистрибутив Linux, где доступен systemd-machined (рекомендуется Debian 11, в Debian 12 есть проблемы с доступом в консоль контейнера)
* Безлимитный трафик, либо как можно больше =)

### Чем пользовался я и что могу посоветовать

*Все ссылки реферальные!!! Оплата в рублях с российских карт и ЮМани, другие способы уточняйте.*

* [RoboVPS](https://www.robovps.biz/?ref=39155)
  * период использования: 17.04.2022 - 17.10.2023
  * очень хороший и стабильный хостинг, ТП отвечает быстро,
    был оптимальный вариант по соотношению цена/качество, пока не повысили цены
  * доступные локации: Германия
  * ChatGPT открывается, но не выдает токен (на момент использования, сейчас не знаю)
  * на 01.01.2025 самый дешевый тариф: 399.00 руб/мес<br>
    (1 ядро/1 ГБ/10 ГБ SSD/до 150 Мбит/сек)

* [HOSTING RUSSIA](https://hosting-russia.ru/?p=37512)
  * период использования: 17.10.2023 - по сегодня
  * очень хороший и стабильный хостинг, ТП отвечает относительно быстро,
    но был случай, когда в момент DDoS атаки ее просто отключили
  * доступные локации: Германия, Нидерланды
  * ChatGPT выдал токен в локации Германия
  * на 01.01.2025 самый дешевый тариф: 349.00 руб/мес<br>
    (1 ядро/1 ГБ/20 ГБ SSD/до 10 Гбит/сек)
  * есть оплата бонусами ЮМани, можно платить за 6 и 12 месяцев со скидкой

* [аéза]
  * **удалили аккаунт с небольшим балансом без предупреждения**
  * тестировал 21.02.2024 локации США, Лондон и Нидерланды для выдачи токена ChatGPT
  * почасовая оплата
  * ChatGPT выдал токен в локации Лондон и Нидерланды, в США - отказался

### Чем пользуются мои друзья

* [FirstVDS](https://firstvds.ru/?from=1001748)
  * доступные локации: Нидерланды
  * на 01.01.2025 самый дешевый тариф: 444.00 руб/мес<br>
    (1 ядро/2 ГБ/40 ГБ SSD/до 200 Мбит/сек)
  
* [TimeWeb](https://timeweb.cloud/?i=127787)
  * доступные локации: Германия, Нидерланды, Казахстан

## Установка

### Автоматическая установка

Входим в систему используя SSH: IP-адрес хоста, логин и пароль обычно выдает хостер.
Все команды выполняем от пользователя `root` или используя `sudo`.

Установщику можно задать следующие переменные окружения:

* `COMMAND` - имя команды, по-умолчанию `install`
* `NAME` - имя контейнера, по-умолчанию `default`
* `IMAGE` - URL-адрес или путь к файлу с образом
* `BACKUP_FILE` - путь к файлу с бекапом OpenVPN для сохранения или восстановления

1.  Установка официального контейнера:
    ```shell
    wget -qO- https://kyzima-spb.github.io/p2p-routing-container/installer.sh | bash
    ```
2.  Установка моей версии контейнера с улучшениями:
    ```shell
    wget -qO- https://kyzima-spb.github.io/p2p-routing-container/installer.sh | \
    IMAGE=https://kyzima-spb.github.io/p2p-routing-container/images/custom/rootfs.tar.xz \
    bash
    ```
3.  Установка контейнера с указанием имени:
    ```shell
    wget -qO- https://kyzima-spb.github.io/p2p-routing-container/installer.sh | \
    NAME=custom \
    bash
    ```

### После установки

После успешной установки должен появиться файл `client-tcp.ovpn`.
Это ваш конфигурационный файл OpenVPN, который нужно импортировать в программу OpenVPN на компьютере
и OpenVPN Connect на Android и iOS.

Если установка выполнялась скриптом, то файл появится в директории, из которой был запущен скрипт.
Если вы не меняли директорию, то по-умолчанию это домашняя директория пользователя.
Для пользователя `root`, то это `/root`, иначе `/home/<USERNAME>`.

Скопируйте файл `client-tcp.ovpn` с сервера на ваш компьютер,
с помощью программы FileZilla (Windows, macOS, Linux) или WinSCP (только для Windows), по протоколу **SFTP**.  

В Linux данный файл можно скачать с сервера командой:
```shell
scp <USER>@<PUBLIC_IP>:<PATH_TO_OVPN_FILE> <DEST_PATH>
```

## Удаление

1.  Чтобы удалить контейнер, образ и все связанные файлы выполните:
    ```shell
    wget -qO- https://kyzima-spb.github.io/p2p-routing-container/installer.sh | \
    COMMAND=uninstall bash
    ```
2.  Если при установке было задано другое имя, то выполните:
    ```shell
    wget -qO- https://kyzima-spb.github.io/p2p-routing-container/installer.sh | \
    COMMAND=uninstall NAME=custom bash
    ```

## Полезные команды

Для входа в контейнер воспользуйтесь командой:
```shell
machinectl shell <CONTAINER_NAME>
```

Команды, которые можно выполнить внутри контейнера:

1.  Обновить сопоставление хостов для проксирования 
    ```shell
    LANG=C.UTF-8 /root/antizapret/doall.sh
    ```
2.  Очистить кеш Knot Resolver
    ```shell
    echo "cache.clear()" | socat - /run/knot-resolver/control/1
    ```

## Особенности контейнера

### Нестандартный способ маршрутизации

Контейнер использует маршрутизацию на основе доменных имен, с помощью специального DNS-сервера, созданного для этой цели.

DNS-резолвер осуществляет отображение (соответствие, маппинг) настоящего IP-адреса домена в свободный IP-адрес большой внутренней подсети,
и отдает запрашиваемому клиенту адрес из внутренней подсети.

У такого подхода есть множество преимуществ:

* Клиенту устанавливается только один или несколько маршрутов, вместо десятков тысяч маршрутов;
* Маршрутизируются только **домены** из списка, а не все домены на одном IP-адресе;
* Возможность обновления списка доменов без переподключения клиента;
* Корректная работа с доменами, постоянно меняющими IP-адреса, и с CDN-сервисами.

Но есть и минусы:

* Необходимо использовать только DNS-сервер из контейнера. С другими DNS-серверами работать не будет.
* Работает только для доменов из списка и программ, использующих эти доменные имена.
  Для IP-адресов необходимо использовать обычную маршрутизацию.

Схематичное представление:

```
📱 — Клиент
🖥 — Контейнер с запущенным DNS-сервером
🖧 — Интернет

📱 → chatgpt.com? → 🖥
  🖥 → chatgpt.com? → 🖧
  🖥 ← 172.64.155.209 ← 🖧
  10.224.0.1 → 172.64.155.209
📱 ← 10.224.0.1 ← 🖥
```

### Намеренное удаление IPv6-адресов

Текущая версия специального DNS-сервера не работает с IPv6 и намеренно удаляет IPv6-адреса (AAAA-записи) из DNS-ответов.

Это не является серьёзным недостатком, так как сайтов, доступных только по IPv6, но не по IPv4, практически не существует.

### Работа со сторонними DNS-зонами

Контейнер настроен на работу с дополнительными доменными зонами:

* OpenNIC (`.bbs, .chan, .cyb, .geek, .pirate` и другие);
* EmerDNS (`.lib, .emc, .coin, .bazar`);
* Namecoin (`.bit`).
